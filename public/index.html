<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HAGAKURE MYSTERY â€” é¡ã®æ³•å‰‡</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700;900&family=Zen+Kaku+Gothic+New:wght@300;400;700&family=Source+Code+Pro:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #060608;
  --bg-card: #0d0d10;
  --bg-input: #111116;
  --border: #1e1e24;
  --text: #b8b4aa;
  --text-dim: #55524a;
  --text-bright: #f0ece0;
  --accent: #c4975a;
  --accent-bright: #e8c07a;
  --accent-dim: #8b6a3a;
  --accent-dark: #3d2a14;
  --red: #c45a5a;
  --red-dim: #6b2a2a;
  --cyan: #5a9b9b;
  --blue: #5a7ac4;
  --font-serif: 'Noto Serif JP', serif;
  --font-sans: 'Zen Kaku Gothic New', sans-serif;
  --font-mono: 'Source Code Pro', monospace;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-sans);
  min-height: 100vh;
  overflow-x: hidden;
}

/* â•â•â• PARTICLE CANVAS â•â•â• */
#particles {
  position: fixed; top: 0; left: 0;
  width: 100%; height: 100%;
  z-index: 0; pointer-events: none;
}

.vignette {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,0.75) 100%);
  pointer-events: none; z-index: 1;
}

/* â•â•â• HUD â•â•â• */
#hud {
  position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
  background: linear-gradient(180deg, rgba(6,6,8,0.97) 0%, rgba(6,6,8,0.88) 80%, transparent 100%);
  padding: 12px 24px 18px;
  backdrop-filter: blur(12px);
}

.hud-inner { max-width: 680px; margin: 0 auto; }

.hud-top {
  display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
}

.hud-logo {
  font-family: var(--font-serif); font-weight: 900;
  font-size: 0.8rem; color: var(--text-bright); letter-spacing: 0.2em;
}

.hud-phase {
  font-family: var(--font-mono); font-size: 0.6rem;
  color: var(--accent); letter-spacing: 0.15em;
  padding: 3px 10px; border: 1px solid var(--accent-dim);
  background: rgba(196,151,90,0.06);
}

.hud-mirror-status {
  font-family: var(--font-mono); font-size: 0.6rem;
  color: var(--text-dim); letter-spacing: 0.1em;
}

.hud-mirror-status .integrity {
  color: var(--accent); font-weight: 600;
  transition: color 0.5s;
}

.hud-mirror-status .integrity.danger { color: var(--red); }
.hud-mirror-status .integrity.good { color: var(--cyan); }

/* Progress */
.progress-track {
  width: 100%; height: 2px;
  background: var(--border); position: relative; overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent-dim), var(--accent), var(--accent-bright));
  width: 0%; transition: width 0.8s cubic-bezier(0.22,1,0.36,1);
  position: relative;
}

.progress-fill::after {
  content: ''; position: absolute; right: 0; top: -2px;
  width: 6px; height: 6px; background: var(--accent-bright);
  border-radius: 50%; box-shadow: 0 0 8px var(--accent);
}

.hud-bottom {
  display: flex; justify-content: space-between; align-items: center;
  margin-top: 6px;
}

.hud-step {
  font-family: var(--font-mono); font-size: 0.58rem;
  color: var(--text-dim); letter-spacing: 0.08em;
}

.hud-step .step-current {
  color: var(--accent); font-weight: 600;
}

.hud-remaining {
  font-family: var(--font-mono); font-size: 0.55rem;
  color: var(--text-dim); letter-spacing: 0.06em;
}

.hud-remaining .remain-num {
  color: var(--accent-dim); font-weight: 600;
}

/* â•â•â• LOADING WITH PERCENTAGE â•â•â• */
.loading-analysis { text-align: center; padding: 50px 0; }

.loading-analysis .loading-pct-ring {
  width: 80px; height: 80px; margin: 0 auto 20px; position: relative;
}

.loading-analysis .loading-pct-ring svg {
  width: 80px; height: 80px; transform: rotate(-90deg);
}

.loading-analysis .loading-pct-ring .ring-bg {
  fill: none; stroke: var(--border); stroke-width: 3;
}

.loading-analysis .loading-pct-ring .ring-fill {
  fill: none; stroke: var(--accent); stroke-width: 3;
  stroke-linecap: round;
  stroke-dasharray: 226;
  stroke-dashoffset: 226;
  transition: stroke-dashoffset 0.3s ease;
}

.loading-analysis .loading-pct-num {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  font-family: var(--font-mono); font-size: 1.1rem;
  font-weight: 600; color: var(--accent); letter-spacing: -0.02em;
}

.loading-analysis .loading-text {
  font-family: var(--font-mono); font-size: 0.72rem;
  color: var(--text-dim); letter-spacing: 0.12em;
}

.loading-analysis .loading-sub {
  font-family: var(--font-mono); font-size: 0.58rem;
  color: var(--text-dim); margin-top: 6px; opacity: 0.5;
}

.loading-analysis .loading-step-detail {
  font-family: var(--font-mono); font-size: 0.55rem;
  color: var(--accent-dim); margin-top: 10px; letter-spacing: 0.06em;
  min-height: 1.2em;
}

/* â•â•â• MIRROR VISUAL â•â•â• */
#mirror-container {
  position: fixed; top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  z-index: 2000; pointer-events: none;
  opacity: 0; transition: opacity 0.6s;
}

#mirror-container.visible {
  opacity: 1;
}

.mirror-frame {
  width: 280px; height: 360px;
  border: 2px solid var(--accent-dim);
  border-radius: 140px 140px 20px 20px;
  position: relative; overflow: hidden;
  background: linear-gradient(180deg, rgba(196,151,90,0.03) 0%, rgba(6,6,8,0.95) 100%);
  box-shadow: 0 0 60px rgba(196,151,90,0.05), inset 0 0 40px rgba(0,0,0,0.5);
}

.mirror-surface {
  position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  background: radial-gradient(ellipse at 50% 30%, rgba(196,151,90,0.06) 0%, transparent 70%);
}

.mirror-reflection {
  position: absolute; top: 15%; left: 50%; transform: translateX(-50%);
  width: 60px; height: 60px; border-radius: 50%;
  background: radial-gradient(circle, rgba(196,151,90,0.15) 0%, transparent 70%);
  filter: blur(8px);
  animation: mirrorPulse 3s ease infinite;
}

@keyframes mirrorPulse {
  0%, 100% { opacity: 0.5; transform: translateX(-50%) scale(1); }
  50% { opacity: 0.8; transform: translateX(-50%) scale(1.1); }
}

/* Cracks SVG overlay */
.mirror-cracks {
  position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  z-index: 10;
}

.mirror-cracks svg {
  width: 100%; height: 100%;
}

.crack-line {
  stroke: rgba(196,151,90,0.4);
  stroke-width: 1.5;
  fill: none;
  stroke-dasharray: 200;
  stroke-dashoffset: 200;
  transition: stroke-dashoffset 1s ease;
  filter: drop-shadow(0 0 3px rgba(196,151,90,0.3));
}

.crack-line.visible {
  stroke-dashoffset: 0;
}

.crack-line.severe {
  stroke: rgba(196,90,90,0.5);
  filter: drop-shadow(0 0 4px rgba(196,90,90,0.3));
}

/* Glow effect for warm responses */
.mirror-glow {
  position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  background: radial-gradient(ellipse at 50% 40%, rgba(196,151,90,0.12) 0%, transparent 70%);
  opacity: 0; transition: opacity 1s;
  z-index: 5;
}

.mirror-glow.active { opacity: 1; }

/* â•â•â• PHASE OVERLAY â•â•â• */
#phase-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  z-index: 2000; display: flex; align-items: center; justify-content: center;
  flex-direction: column; background: var(--bg);
  opacity: 0; pointer-events: none; transition: opacity 0.4s;
}

#phase-overlay.active { opacity: 1; pointer-events: all; }

#phase-overlay .phase-big-num {
  font-family: var(--font-mono); font-size: 7rem; font-weight: 300;
  color: var(--accent); opacity: 0.12; line-height: 1;
}

#phase-overlay .phase-big-title {
  font-family: var(--font-serif); font-size: 1.5rem;
  color: var(--text-bright); font-weight: 900; letter-spacing: 0.15em; margin-top: -16px;
}

#phase-overlay .phase-big-sub {
  font-family: var(--font-mono); font-size: 0.72rem;
  color: var(--accent-dim); letter-spacing: 0.1em; margin-top: 12px;
}

/* â•â•â• MAIN â•â•â• */
#app {
  max-width: 680px; margin: 0 auto;
  padding: 100px 24px 120px;
  position: relative; z-index: 2;
}

/* â•â•â• BLOCKS â•â•â• */
.message-block {
  opacity: 0; transform: translateY(20px);
  animation: fadeUp 0.7s cubic-bezier(0.22,1,0.36,1) forwards;
  margin-bottom: 28px;
}

@keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }

.narrative {
  font-family: var(--font-serif); font-size: 1rem;
  line-height: 2.4; color: var(--text); white-space: pre-line;
}

.narrative.dim { color: var(--text-dim); }

/* Mirror speech bubble */
.mirror-speech {
  border: 1px solid var(--border); border-left: 3px solid var(--accent-dim);
  padding: 24px; margin: 24px 0;
  background: linear-gradient(135deg, rgba(196,151,90,0.03) 0%, var(--bg-card) 100%);
  position: relative;
}

.mirror-speech::before {
  content: 'é¡'; position: absolute; top: -10px; left: 16px;
  font-family: var(--font-mono); font-size: 0.55rem;
  color: var(--accent); letter-spacing: 0.2em;
  background: var(--bg); padding: 2px 8px;
  border: 1px solid var(--accent-dim);
}

.mirror-speech .speech-text {
  font-family: var(--font-serif); font-size: 0.95rem;
  line-height: 2.2; color: var(--text-bright); font-style: italic;
}

/* Emotion meter */
.emotion-meter {
  margin: 16px 0; padding: 16px 20px;
  border: 1px solid var(--border); background: var(--bg-card);
  font-family: var(--font-mono); font-size: 0.72rem;
}

.emotion-meter .meter-title {
  font-size: 0.6rem; color: var(--text-dim);
  letter-spacing: 0.2em; margin-bottom: 12px;
}

.meter-row {
  display: flex; align-items: center; gap: 12px; margin: 8px 0;
}

.meter-label {
  min-width: 80px; font-size: 0.68rem; color: var(--text-dim);
}

.meter-track {
  flex: 1; height: 6px; background: var(--border);
  position: relative; overflow: hidden;
}

.meter-fill {
  height: 100%; width: 0%;
  transition: width 1s cubic-bezier(0.22,1,0.36,1);
  position: relative;
}

.meter-fill.warmth { background: linear-gradient(90deg, var(--accent-dim), var(--accent)); }
.meter-fill.empathy { background: linear-gradient(90deg, #3a6b5a, var(--cyan)); }
.meter-fill.severity { background: linear-gradient(90deg, var(--red-dim), var(--red)); }

.meter-fill::after {
  content: ''; position: absolute; right: 0; top: -1px; bottom: -1px;
  width: 2px; box-shadow: 0 0 4px currentColor;
}

.meter-fill.warmth::after { background: var(--accent-bright); }
.meter-fill.empathy::after { background: var(--cyan); }
.meter-fill.severity::after { background: var(--red); }

.meter-val {
  min-width: 28px; text-align: right; font-size: 0.65rem; font-weight: 600;
}

.meter-val.warm { color: var(--accent); }
.meter-val.emp { color: var(--cyan); }
.meter-val.sev { color: var(--red); }

/* Flame meter */
.flame-indicator {
  display: flex; align-items: center; gap: 8px;
  margin-top: 12px; padding-top: 12px;
  border-top: 1px solid var(--border);
}

.flame-icon {
  font-size: 1rem; filter: saturate(0.7);
  transition: filter 0.5s, transform 0.5s;
}

.flame-icon.lit { filter: saturate(1.2); transform: scale(1.1); }

.flame-text {
  font-size: 0.65rem; color: var(--text-dim); letter-spacing: 0.05em;
}

.flame-text .flame-val {
  color: var(--accent); font-weight: 600;
}

/* Impact notice */
.impact-notice {
  text-align: center; padding: 12px; margin: 8px 0;
  font-family: var(--font-mono); font-size: 0.7rem;
  letter-spacing: 0.1em; animation: impactFlash 0.6s ease;
}

.impact-notice.warm {
  color: var(--accent); border: 1px solid rgba(196,151,90,0.2);
  background: rgba(196,151,90,0.04);
}

.impact-notice.cold {
  color: var(--red); border: 1px solid rgba(196,90,90,0.2);
  background: rgba(196,90,90,0.04);
}

.impact-notice.neutral {
  color: var(--text-dim); border: 1px solid var(--border);
}

@keyframes impactFlash {
  0% { opacity: 0; transform: scale(0.95); }
  50% { opacity: 1; transform: scale(1.02); }
  100% { opacity: 1; transform: scale(1); }
}

/* Phase header */
.phase-header {
  border: 1px solid var(--border); border-left: 3px solid var(--accent);
  padding: 20px 24px; margin: 40px 0 24px; background: var(--bg-card);
  position: relative; overflow: hidden;
}

.phase-header::after {
  content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  background: linear-gradient(90deg, rgba(196,151,90,0.04) 0%, transparent 100%);
  pointer-events: none;
}

.phase-header .phase-label {
  font-family: var(--font-mono); font-size: 0.6rem;
  color: var(--accent); letter-spacing: 0.35em; margin-bottom: 8px;
}

.phase-header .phase-title {
  font-family: var(--font-serif); font-size: 1.3rem;
  color: var(--text-bright); font-weight: 900;
}

.phase-header .phase-sub {
  font-family: var(--font-mono); font-size: 0.68rem;
  color: var(--text-dim); margin-top: 6px;
}

/* Question / Input */
.question-block { margin: 28px 0; position: relative; padding-left: 16px; }

.question-block::before {
  content: ''; position: absolute; left: 0; top: 4px; bottom: 4px;
  width: 2px; background: linear-gradient(180deg, var(--accent), transparent);
}

.question-label {
  font-family: var(--font-mono); font-size: 0.6rem;
  color: var(--accent); letter-spacing: 0.25em; margin-bottom: 12px;
}

.question-text {
  font-family: var(--font-serif); font-size: 1.05rem;
  line-height: 2.2; color: var(--text-bright);
}

.input-area { margin: 24px 0; }

.input-area textarea {
  width: 100%; min-height: 120px;
  background: var(--bg-input); border: 1px solid var(--border);
  color: var(--text-bright); font-family: var(--font-sans);
  font-size: 0.95rem; line-height: 1.9; padding: 18px;
  resize: vertical; outline: none;
  transition: border-color 0.3s, box-shadow 0.3s;
}

.input-area textarea:focus {
  border-color: var(--accent-dim);
  box-shadow: 0 0 20px rgba(196,151,90,0.05);
}

.input-area textarea::placeholder { color: var(--text-dim); font-style: italic; }

.submit-btn {
  display: flex; align-items: center; gap: 8px;
  margin-top: 12px; padding: 12px 28px;
  background: transparent; border: 1px solid var(--accent-dim);
  color: var(--accent); font-family: var(--font-mono);
  font-size: 0.72rem; letter-spacing: 0.2em;
  cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden;
}

.submit-btn::before {
  content: ''; position: absolute; top: 0; left: -100%;
  width: 100%; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(196,151,90,0.08), transparent);
  transition: left 0.5s;
}

.submit-btn:hover::before { left: 100%; }
.submit-btn:hover { border-color: var(--accent); box-shadow: 0 0 16px rgba(196,151,90,0.1); }
.submit-btn:disabled { opacity: 0.2; cursor: not-allowed; }

.user-answer {
  border-left: 2px solid var(--accent-dim); padding: 14px 20px; margin: 16px 0;
  font-family: var(--font-sans); font-size: 0.86rem;
  color: var(--text-dim); line-height: 1.9;
  background: rgba(196,151,90,0.02);
}

.user-answer::before {
  content: 'YOUR RESPONSE'; font-family: var(--font-mono);
  font-size: 0.5rem; letter-spacing: 0.2em;
  color: var(--accent-dim); display: block; margin-bottom: 6px;
}

/* Divider */
.divider-line {
  font-family: var(--font-mono); color: var(--text-dim);
  font-size: 0.6rem; letter-spacing: 0.25em; margin: 36px 0;
  text-align: center; display: flex; align-items: center; gap: 16px;
}

.divider-line::before, .divider-line::after {
  content: ''; flex: 1; height: 1px;
  background: linear-gradient(90deg, transparent, var(--border), transparent);
}

/* Loading spinner rings (used inside pct ring as fallback) */

/* â•â•â• OUTPUT SECTIONS â•â•â• */
.output-section {
  border: 1px solid var(--border); margin: 36px 0;
  background: var(--bg-card); opacity: 0; transform: translateY(24px);
  animation: outputReveal 0.8s cubic-bezier(0.22,1,0.36,1) forwards;
  position: relative; overflow: hidden;
}

@keyframes outputReveal { to { opacity: 1; transform: translateY(0); } }

.output-section::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0;
  height: 1px; background: linear-gradient(90deg, transparent, var(--accent-dim), transparent);
}

.output-header {
  border-bottom: 1px solid var(--border); padding: 18px 24px;
  font-family: var(--font-serif); font-size: 1rem;
  color: var(--text-bright); font-weight: 900;
  background: linear-gradient(90deg, rgba(196,151,90,0.05) 0%, transparent 100%);
  letter-spacing: 0.05em;
}

.output-header .output-icon {
  display: inline-block; width: 20px; height: 20px;
  border: 1px solid var(--accent-dim); border-radius: 2px;
  text-align: center; line-height: 20px; font-size: 0.55rem;
  font-family: var(--font-mono); color: var(--accent);
  margin-right: 10px; vertical-align: middle;
}

.output-body {
  padding: 28px 24px; font-family: var(--font-sans);
  font-size: 0.86rem; line-height: 2.1; color: var(--text); white-space: pre-line;
}

.output-body h3 {
  font-family: var(--font-serif); font-size: 0.88rem;
  color: var(--accent); margin: 24px 0 10px; font-weight: 700;
}

.output-body h3:first-child { margin-top: 0; }

/* Stat rows */
.stat-row { display: flex; align-items: center; gap: 14px; margin: 12px 0; }

.stat-label {
  min-width: 130px; color: var(--text-dim);
  font-family: var(--font-mono); font-size: 0.7rem; letter-spacing: 0.05em;
}

.stat-bar-track { flex: 1; height: 8px; background: var(--border); overflow: hidden; }

.stat-bar-fill {
  height: 100%; width: 0%;
  transition: width 1.2s cubic-bezier(0.22,1,0.36,1);
}

.stat-bar-fill.gold { background: linear-gradient(90deg, var(--accent-dim), var(--accent)); }
.stat-bar-fill.cyan { background: linear-gradient(90deg, #2a5b5b, var(--cyan)); }
.stat-bar-fill.red-bar { background: linear-gradient(90deg, var(--red-dim), var(--red)); }

.stat-bar-fill::after {
  content: ''; position: absolute; right: 0; top: 0; bottom: 0;
  width: 2px; box-shadow: 0 0 6px currentColor;
}

.stat-value {
  font-family: var(--font-mono); font-size: 0.68rem;
  min-width: 32px; text-align: right; font-weight: 600;
}

/* Title award */
.title-award {
  text-align: center; padding: 48px 32px;
  border: 1px solid var(--accent-dim); background: var(--bg-card);
  margin: 40px 0; position: relative; overflow: hidden;
}

.title-award::before {
  content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
  background: conic-gradient(from 0deg, transparent, rgba(196,151,90,0.03), transparent, rgba(196,151,90,0.03), transparent);
  animation: titleRotate 12s linear infinite;
}

@keyframes titleRotate { to { transform: rotate(360deg); } }

.title-award .award-label {
  font-family: var(--font-mono); font-size: 0.58rem;
  color: var(--text-dim); letter-spacing: 0.35em; position: relative;
}

.title-award .award-name {
  font-family: var(--font-serif); font-size: 1.7rem;
  color: var(--accent-bright); font-weight: 900;
  margin: 20px 0 16px; letter-spacing: 0.08em;
  text-shadow: 0 0 30px rgba(196,151,90,0.2); position: relative;
}

.title-award .award-desc {
  font-family: var(--font-sans); font-size: 0.86rem;
  color: var(--text); line-height: 2; position: relative;
}

/* Closing */
.closing-block {
  border: 1px solid var(--accent-dim); padding: 48px 32px;
  margin: 56px 0; text-align: center; background: var(--bg-card); position: relative;
}

.closing-block::before, .closing-block::after {
  content: ''; position: absolute; width: 40px; height: 40px;
  border-color: var(--accent-dim); border-style: solid;
}

.closing-block::before { top: -1px; left: -1px; border-width: 1px 0 0 1px; }
.closing-block::after { bottom: -1px; right: -1px; border-width: 0 1px 1px 0; }

.closing-block .closing-title {
  font-family: var(--font-serif); font-size: 1.2rem;
  color: var(--text-bright); font-weight: 900; letter-spacing: 0.25em; margin-bottom: 28px;
}

.closing-block .closing-text {
  font-family: var(--font-serif); font-size: 0.9rem;
  line-height: 2.6; color: var(--text); white-space: pre-line;
}

.closing-block .case-closed {
  font-family: var(--font-mono); font-size: 0.85rem;
  color: var(--accent); letter-spacing: 0.5em;
  margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border);
}

/* â•â•â• SALES CLOSING (è‘‰éš ã‚»ãƒ¼ãƒ«ã‚¹) â•â•â• */
.sales-section {
  margin: 56px 0 40px;
  border: 1px solid var(--accent-dim);
  background: var(--bg-card);
  position: relative;
  overflow: hidden;
}

.sales-section::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0;
  height: 1px; background: linear-gradient(90deg, transparent, var(--accent), transparent);
}

.sales-header {
  text-align: center; padding: 48px 32px 0;
}

.sales-header .sales-logo {
  font-family: var(--font-serif); font-size: 1.8rem;
  color: var(--text-bright); font-weight: 900; letter-spacing: 0.3em;
}

.sales-hook {
  padding: 12px 32px 0; text-align: center;
}

.sales-hook .hook-personal {
  font-family: var(--font-serif); font-size: 0.95rem;
  color: var(--accent); line-height: 2.2; font-style: italic;
  padding: 16px 0; border-bottom: 1px solid var(--border);
  margin-bottom: 16px;
}

.sales-body {
  padding: 24px 32px 0;
  text-align: center;
}

.sales-body .sales-text {
  font-family: var(--font-serif); font-size: 0.92rem;
  line-height: 2.8; color: var(--text);
  white-space: pre-line;
}

.sales-body .sales-text .emp {
  color: var(--text-bright); font-weight: 700;
}

.sales-question {
  text-align: center; padding: 32px;
  font-family: var(--font-serif); font-size: 1.05rem;
  color: var(--text-bright); font-weight: 700; line-height: 2.4;
}

.sales-condition {
  text-align: center; padding: 0 32px 24px;
  font-family: var(--font-serif); font-size: 0.88rem;
  color: var(--text-dim); line-height: 2.4;
}

.sales-final {
  text-align: center; padding: 24px 32px 40px;
  font-family: var(--font-serif); font-size: 0.88rem;
  color: var(--text-dim); line-height: 2.4;
  border-top: 1px solid var(--border);
}

.sales-final .final-accent {
  color: var(--accent); font-weight: 700;
}

/* LINE CTA */
.line-cta-wrap {
  text-align: center; padding: 0 32px 48px;
}

.line-cta {
  display: inline-flex; align-items: center; gap: 12px;
  padding: 16px 40px;
  background: #06C755;
  border: none; border-radius: 4px;
  color: #fff;
  font-family: var(--font-sans); font-size: 0.92rem;
  font-weight: 700; letter-spacing: 0.05em;
  text-decoration: none;
  transition: all 0.3s;
  position: relative; overflow: hidden;
}

.line-cta::before {
  content: ''; position: absolute; top: 0; left: -100%;
  width: 100%; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
  transition: left 0.6s;
}

.line-cta:hover::before { left: 100%; }

.line-cta:hover {
  background: #05b34c;
  box-shadow: 0 0 24px rgba(6,199,85,0.25);
  transform: translateY(-1px);
}

.line-cta svg {
  width: 22px; height: 22px; fill: #fff;
}

.line-cta-sub {
  font-family: var(--font-mono); font-size: 0.58rem;
  color: var(--text-dim); letter-spacing: 0.1em;
  margin-top: 12px;
}

/* case closed after sales */
.case-closed-final {
  text-align: center; padding: 24px;
  font-family: var(--font-mono); font-size: 0.8rem;
  color: var(--accent); letter-spacing: 0.5em;
  margin: 0 0 40px;
}

/* Title card */
.title-card { text-align: center; padding: 40px 0 24px; }

.title-card h1 {
  font-family: var(--font-serif); font-weight: 900;
  font-size: 2.4rem; color: var(--text-bright); letter-spacing: 0.3em;
  position: relative; display: inline-block;
}

.title-card h1::after {
  content: ''; position: absolute; bottom: -8px; left: 20%; right: 20%;
  height: 1px; background: linear-gradient(90deg, transparent, var(--accent-dim), transparent);
}

.title-card .subtitle {
  font-family: var(--font-mono); font-size: 0.68rem;
  color: var(--accent); letter-spacing: 0.35em; margin-top: 20px;
}

.title-card .case-number {
  font-family: var(--font-mono); font-size: 0.68rem;
  color: var(--text-dim); letter-spacing: 0.2em; margin-top: 12px;
}

/* Mirror integrity visual (big) */
.mirror-integrity-display {
  text-align: center; padding: 24px; margin: 24px 0;
  border: 1px solid var(--border); background: var(--bg-card);
}

.mirror-integrity-display .big-pct {
  font-family: var(--font-mono); font-size: 3rem;
  font-weight: 300; letter-spacing: -0.02em;
  transition: color 0.5s;
}

.mirror-integrity-display .big-pct.healthy { color: var(--accent); }
.mirror-integrity-display .big-pct.warning { color: var(--accent-dim); }
.mirror-integrity-display .big-pct.danger { color: var(--red); }

.mirror-integrity-display .int-label {
  font-family: var(--font-mono); font-size: 0.58rem;
  color: var(--text-dim); letter-spacing: 0.2em; margin-top: 4px;
}

@media (max-width: 600px) {
  #app { padding: 96px 16px 100px; }
  .title-card h1 { font-size: 1.7rem; }
  .stat-label { min-width: 90px; font-size: 0.62rem; }
  .title-award .award-name { font-size: 1.3rem; }
  .mirror-frame { width: 220px; height: 280px; }
}
</style>
</head>
<body>

<canvas id="particles"></canvas>
<div class="vignette"></div>

<div id="hud">
  <div class="hud-inner">
    <div class="hud-top">
      <div class="hud-logo">HAGAKURE</div>
      <div class="hud-phase" id="hud-phase">OPENING</div>
      <div class="hud-mirror-status">é¡ã®å¥å…¨åº¦ <span class="integrity" id="hud-integrity">100%</span></div>
    </div>
    <div class="progress-track">
      <div class="progress-fill" id="progress-fill"></div>
    </div>
    <div class="hud-bottom">
      <div class="hud-step" id="hud-step">æº–å‚™ä¸­</div>
      <div class="hud-remaining" id="hud-remaining"></div>
    </div>
  </div>
</div>

<div id="phase-overlay">
  <div class="phase-big-num" id="overlay-num"></div>
  <div class="phase-big-title" id="overlay-title"></div>
  <div class="phase-big-sub" id="overlay-sub"></div>
</div>

<div id="app">
  <div id="content"></div>
</div>

<script>
// â•â•â• PARTICLES â•â•â•
const canvas = document.getElementById('particles');
const ctx = canvas.getContext('2d');
let pts = [];

function resize() { canvas.width = innerWidth; canvas.height = innerHeight; }
resize(); addEventListener('resize', resize);

class P {
  constructor() { this.reset(); }
  reset() {
    this.x = Math.random() * canvas.width;
    this.y = Math.random() * canvas.height;
    this.s = Math.random() * 1.2 + 0.3;
    this.vy = -(Math.random() * 0.25 + 0.05);
    this.vx = (Math.random() - 0.5) * 0.12;
    this.o = Math.random() * 0.2 + 0.05;
    this.fd = Math.random() * 0.002 + 0.001;
    this.ph = Math.random() * Math.PI * 2;
  }
  update() {
    this.y += this.vy; this.x += this.vx + Math.sin(this.ph) * 0.04;
    this.ph += 0.01; this.o -= this.fd;
    if (this.o <= 0 || this.y < -10) this.reset();
  }
  draw() {
    ctx.fillStyle = `rgba(196,151,90,${this.o})`;
    ctx.beginPath(); ctx.arc(this.x, this.y, this.s, 0, Math.PI * 2); ctx.fill();
  }
}

for (let i = 0; i < 40; i++) pts.push(new P());
(function loop() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  pts.forEach(p => { p.update(); p.draw(); });
  requestAnimationFrame(loop);
})();

// â•â•â• GAME STATE â•â•â•
const state = {
  phase: 'opening',
  mirrorIntegrity: 100, // 0â€“100
  totalFlame: 0,
  responseCount: 0,
  seedAnswers: {},      // Phase 1 answers (your weaknesses)
  mirrorDialogues: [],  // Mirror's questions
  playerResponses: [],  // Your responses to mirror
  emotionScores: [],    // Per-response scores
};

const content = document.getElementById('content');
const progressFill = document.getElementById('progress-fill');
const hudPhase = document.getElementById('hud-phase');
const hudIntegrity = document.getElementById('hud-integrity');

// â•â•â• HELPERS â•â•â•
function addBlock(html, cls = '') {
  const div = document.createElement('div');
  div.className = `message-block ${cls}`;
  div.innerHTML = html;
  content.appendChild(div);
  setTimeout(() => div.scrollIntoView({ behavior: 'smooth', block: 'end' }), 100);
  return div;
}

function addNarrative(text, dim = false) {
  return addBlock(`<div class="narrative ${dim ? 'dim' : ''}">${text}</div>`);
}

function addDivider(t) {
  return addBlock(`<div class="divider-line">${t}</div>`);
}

function addMirrorSpeech(text) {
  return addBlock(`
    <div class="mirror-speech">
      <div class="speech-text">${text.replace(/\n/g, '<br>')}</div>
    </div>
  `);
}

function addQuestion(label, text) {
  return addBlock(`
    <div class="question-block">
      ${label ? `<div class="question-label">ã€${label}ã€‘</div>` : ''}
      <div class="question-text">${text.replace(/\n/g, '<br>')}</div>
    </div>
  `);
}

function showInput(placeholder = '', btnText = 'å›ç­”ã™ã‚‹') {
  const div = addBlock(`
    <div class="input-area">
      <textarea placeholder="${placeholder || 'ç­”ãˆã‚’å…¥åŠ›ã—ã‚ã€‚'}" rows="4"></textarea>
      <button class="submit-btn" onclick="submitAnswer()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
        ${btnText}
      </button>
    </div>
  `);
  const ta = div.querySelector('textarea');
  ta.addEventListener('keydown', e => {
    if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) submitAnswer();
  });
  ta.focus();
  return div;
}

function addUserAnswer(text) {
  return addBlock(`<div class="user-answer">${text.replace(/\n/g, '<br>')}</div>`);
}

function updateProgress(pct) {
  progressFill.style.width = Math.min(pct, 100) + '%';
}

function updateIntegrityHUD() {
  const v = Math.max(0, Math.round(state.mirrorIntegrity));
  hudIntegrity.textContent = v + '%';
  hudIntegrity.className = 'integrity' + (v <= 30 ? ' danger' : v <= 60 ? '' : ' good');
}

function showLoading(text = 'è§£æä¸­', sub = '', steps = []) {
  const id = 'loader-' + Date.now();
  const block = addBlock(`
    <div class="loading-analysis" id="${id}">
      <div class="loading-pct-ring">
        <svg viewBox="0 0 80 80">
          <circle class="ring-bg" cx="40" cy="40" r="36"/>
          <circle class="ring-fill" cx="40" cy="40" r="36"/>
        </svg>
        <div class="loading-pct-num">0%</div>
      </div>
      <div class="loading-text">${text}</div>
      ${sub ? `<div class="loading-sub">${sub}</div>` : ''}
      <div class="loading-step-detail"></div>
    </div>
  `);

  // Animate percentage up with step labels
  const circumference = 2 * Math.PI * 36; // ~226
  const ringFill = block.querySelector('.ring-fill');
  const pctNum = block.querySelector('.loading-pct-num');
  const stepDetail = block.querySelector('.loading-step-detail');
  ringFill.style.strokeDasharray = circumference;
  ringFill.style.strokeDashoffset = circumference;

  let currentPct = 0;
  const targetPct = 92; // stays at 92% until API returns
  const stepMessages = steps.length > 0 ? steps : [
    'è¨¼è¨€ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦',
    'ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç…§åˆä¸­â€¦',
    'æ·±å±¤è§£æã‚’å®Ÿè¡Œä¸­â€¦',
    'çµæœã‚’æ§‹ç¯‰ä¸­â€¦'
  ];

  const intervalMs = 120;
  const pctPerTick = targetPct / (stepMessages.length * 12);
  let stepIdx = 0;
  let tickInStep = 0;

  const timer = setInterval(() => {
    currentPct = Math.min(currentPct + pctPerTick, targetPct);
    const rounded = Math.round(currentPct);
    pctNum.textContent = rounded + '%';
    const offset = circumference - (circumference * currentPct / 100);
    ringFill.style.strokeDashoffset = offset;

    tickInStep++;
    if (tickInStep >= 12 && stepIdx < stepMessages.length - 1) {
      stepIdx++;
      tickInStep = 0;
    }
    stepDetail.textContent = stepMessages[stepIdx];

    if (currentPct >= targetPct) clearInterval(timer);
  }, intervalMs);

  // Return a complete function to jump to 100%
  return {
    block,
    complete: () => {
      clearInterval(timer);
      currentPct = 100;
      pctNum.textContent = '100%';
      ringFill.style.strokeDashoffset = 0;
      stepDetail.textContent = 'å®Œäº†';
    },
    remove: () => {
      clearInterval(timer);
      block.remove();
    }
  };
}

const hudStep = document.getElementById('hud-step');
const hudRemaining = document.getElementById('hud-remaining');
const TOTAL_STEPS = 8; // 3 seed + 5 mirror

function updateStepHUD(current, total, label) {
  total = total || TOTAL_STEPS;
  const remaining = Math.max(0, total - current);
  hudStep.innerHTML = `<span class="step-current">${current}</span> / ${total}ã€€${label || ''}`;
  if (remaining > 0) {
    hudRemaining.innerHTML = `æ®‹ã‚Š <span class="remain-num">${remaining}</span> å•`;
  } else {
    hudRemaining.innerHTML = `<span style="color:var(--accent);">å…¨å•å®Œäº†</span>`;
  }
}

function removeEl(sel) {
  const el = document.querySelector(sel);
  el?.closest('.message-block')?.remove();
}

// Phase transition
function showPhaseTransition(num, title, sub) {
  return new Promise(resolve => {
    const overlay = document.getElementById('phase-overlay');
    document.getElementById('overlay-num').textContent = num;
    document.getElementById('overlay-title').textContent = title;
    document.getElementById('overlay-sub').textContent = sub;
    overlay.classList.add('active');
    setTimeout(() => { overlay.classList.remove('active'); setTimeout(resolve, 400); }, 2200);
  });
}

// Show emotion meter
function showEmotionMeter(warmth, empathy, severity, flameGain) {
  const block = addBlock(`
    <div class="emotion-meter">
      <div class="meter-title">RESPONSE ANALYSIS</div>
      <div class="meter-row">
        <span class="meter-label">æ¸©ã‹ã•</span>
        <div class="meter-track"><div class="meter-fill warmth" data-val="${warmth * 10}" style="width:0%"></div></div>
        <span class="meter-val warm">${warmth}</span>
      </div>
      <div class="meter-row">
        <span class="meter-label">å…±æ„Ÿåº¦</span>
        <div class="meter-track"><div class="meter-fill empathy" data-val="${empathy * 10}" style="width:0%"></div></div>
        <span class="meter-val emp">${empathy}</span>
      </div>
      <div class="meter-row">
        <span class="meter-label">å³ã—ã•</span>
        <div class="meter-track"><div class="meter-fill severity" data-val="${severity * 10}" style="width:0%"></div></div>
        <span class="meter-val sev">${severity}</span>
      </div>
      <div class="flame-indicator">
        <span class="flame-icon ${flameGain > 0 ? 'lit' : ''}">ğŸ”¥</span>
        <span class="flame-text">å¿ƒã«ç¯ã£ãŸç« <span class="flame-val">+${flameGain}</span></span>
      </div>
    </div>
  `);
  setTimeout(() => {
    block.querySelectorAll('.meter-fill').forEach(f => { f.style.width = f.dataset.val + '%'; });
  }, 200);
  return block;
}

function showImpact(type, text) {
  addBlock(`<div class="impact-notice ${type}">${text}</div>`);
}

// â•â•â• GAME FLOW â•â•â•
let currentStep = 0;
let awaitingCallback = null;

// Steps: opening â†’ 3 seed questions â†’ mirror phase (5 rounds) â†’ final analysis
const SEED_QUESTIONS = [
  { label: 'å‘Šç™½1', text: 'ã‚ãªãŸãŒæœ€ã‚‚å¼±ã„ã¨æ„Ÿã˜ã‚‹ç¬é–“ã‚’ã€ä¸€ã¤è©±ã—ã¦ã»ã—ã„ã€‚\nå…·ä½“çš„ã«ã€‚ã©ã‚“ãªå ´é¢ã§ã€ä½•ãŒèµ·ãã‚‹ã‹ã€‚', placeholder: 'å…·ä½“çš„ãªå ´é¢ã‚’è©±ã›ã€‚' },
  { label: 'å‘Šç™½2', text: 'ã‚ãªãŸãŒèª°ã«ã‚‚è¦‹ã›ãŸããªã„è‡ªåˆ†ã®ä¸€é¢ã¯ä½•ã‹ã€‚\nãªãœéš ã—ã¦ã„ã‚‹ã‹ã€‚', placeholder: 'éš ã—ã¦ã„ã‚‹ç†ç”±ã¾ã§è©±ã›ã€‚' },
  { label: 'å‘Šç™½3', text: 'ã‚ãªãŸãŒæœ€ã‚‚æã‚Œã¦ã„ã‚‹ã“ã¨ã¯ä½•ã‹ã€‚\nãã®æã‚Œã®æ­£ä½“ã‚’ã€ã§ãã‚‹é™ã‚Šæ­£ç¢ºã«è¨€èªåŒ–ã—ã¦ã»ã—ã„ã€‚', placeholder: 'æã‚Œã®æ­£ä½“ã‚’è¨€èªåŒ–ã—ã‚ã€‚' }
];

function submitAnswer() {
  const ta = document.querySelector('.input-area textarea');
  if (!ta) return;
  const answer = ta.value.trim();
  if (!answer) return;

  ta.disabled = true;
  document.querySelector('.submit-btn').disabled = true;
  addUserAnswer(answer);

  if (awaitingCallback) {
    const cb = awaitingCallback;
    awaitingCallback = null;
    cb(answer);
  }
}

// â•â•â• START â•â•â•
function startGame() {
  updateProgress(0);
  updateStepHUD(0, TOTAL_STEPS, 'æº–å‚™ä¸­');

  addBlock(`
    <div class="title-card">
      <h1>HAGAKURE MYSTERY</h1>
      <div class="subtitle">â€”â€”é¡ã®æ³•å‰‡</div>
      <div class="case-number">case.001ã€€â€”â€”ã‚ãªãŸãŒæ˜ ã™ã€ã‚ãªãŸ</div>
    </div>
  `);

  setTimeout(() => {
    addNarrative(`ã“ã®éƒ¨å±‹ã«ã¯ã€ä¸€æšã®é¡ãŒã‚ã‚‹ã€‚

ãŸã ã®é¡ã§ã¯ãªã„ã€‚
ã“ã®é¡ã¯â€”â€”ã‚ãªãŸã®å¼±ã•ã‚’æ˜ ã—ã€
ã‚ãªãŸã«ã€èªã‚Šã‹ã‘ã¦ãã‚‹ã€‚

é¡ã¯æ‚©ã‚“ã§ã„ã‚‹ã€‚è‹¦ã—ã‚“ã§ã„ã‚‹ã€‚
ã—ã‹ã—ãã®æ‚©ã¿ã¯ã€ã™ã¹ã¦ã‚ãªãŸè‡ªèº«ã®ã‚‚ã®ã ã€‚`);
  }, 800);

  setTimeout(() => {
    addNarrative(`ã‚ãªãŸãŒã©ã†å¿œã˜ã‚‹ã‹â€”â€”
ãã‚ŒãŒã€ã‚ãªãŸã®æœ¬å½“ã®å§¿ã‚’æš´ãã€‚

å†·ãŸãçªãæ”¾ã›ã°ã€é¡ã¯ã²ã³å‰²ã‚Œã‚‹ã€‚
æ¸©ã‹ãå‘ãåˆãˆã°ã€é¡ã¯å…‰ã‚’å¢—ã™ã€‚

ã¤ã¾ã‚Šã€ã‚ãªãŸãŒå£Šã™ã®ã‚‚
æ•‘ã†ã®ã‚‚â€”â€”ã‚ãªãŸè‡ªèº«ã ã€‚`, true);
  }, 1600);

  setTimeout(() => {
    addDivider('æº–å‚™');
    addNarrative(`ã¾ãšã€é¡ã«æ˜ ã™ç´ æãŒå¿…è¦ã ã€‚
ã‚ãªãŸã®å¼±ã•ã‚’ã€ä¸‰ã¤æ•™ãˆã¦ã‚‚ã‚‰ã†ã€‚

æ­£ç›´ã§ã‚ã‚‹ã“ã¨ã ã‘ãŒã€æ¡ä»¶ã ã€‚`);
    setTimeout(() => askSeedQuestion(0), 600);
  }, 2600);
}

function askSeedQuestion(idx) {
  if (idx >= SEED_QUESTIONS.length) {
    // All seeds collected, start mirror phase
    setTimeout(startMirrorPhase, 600);
    return;
  }

  const q = SEED_QUESTIONS[idx];
  updateProgress((idx / 8) * 100);
  updateStepHUD(idx + 1, TOTAL_STEPS, 'å‘Šç™½ãƒ•ã‚§ãƒ¼ã‚º');
  addQuestion(q.label, q.text);
  showInput(q.placeholder, 'å‘Šç™½ã™ã‚‹');

  awaitingCallback = (answer) => {
    state.seedAnswers[idx] = answer;
    addBlock(`
      <div class="evidence-tag" style="border:1px solid var(--accent-dim); background:rgba(196,151,90,0.04); padding:12px 16px; font-family:var(--font-mono); font-size:0.7rem; color:var(--accent); letter-spacing:0.05em;">
        <span style="font-size:0.55rem; color:var(--text-dim); letter-spacing:0.2em; display:block; margin-bottom:4px;">WEAKNESS REGISTERED</span>
        ç´ æ #${String(idx + 1).padStart(2, '0')}ã€€è¨˜éŒ²å®Œäº†
      </div>
    `);
    setTimeout(() => askSeedQuestion(idx + 1), 600);
  };
}

// â•â•â• MIRROR PHASE â•â•â•
async function startMirrorPhase() {
  hudPhase.textContent = 'MIRROR PHASE';
  await showPhaseTransition('é¡', 'é¡ã®æ³•å‰‡', 'ã‚ãªãŸã®å¼±ã•ãŒã€ã‚ãªãŸã«èªã‚Šã‹ã‘ã‚‹');

  addBlock(`
    <div class="phase-header">
      <div class="phase-label">MIRROR PHASE</div>
      <div class="phase-title">é¡ã®æ³•å‰‡</div>
      <div class="phase-sub">â€”â€”ã‚ãªãŸã®å¼±ã•ãŒã€ã‚ãªãŸã«å•ã„ã‹ã‘ã‚‹</div>
    </div>
  `);

  addNarrative(`é¡ã®æº–å‚™ãŒã§ããŸã€‚

ä»Šã‹ã‚‰é¡ãŒã€ã‚ãªãŸã®å¼±ã•ã‚’ä½¿ã£ã¦èªã‚Šã‹ã‘ã‚‹ã€‚
é¡ã¯è‹¦ã—ã‚“ã§ã„ã‚‹ã€‚é¡ã¯è¿·ã£ã¦ã„ã‚‹ã€‚

ã‚ãªãŸã¯ã€ã©ã†å¿œã˜ã‚‹ã‹ã€‚

è¦šãˆã¦ãŠã‘â€”â€”
é¡ã«æ˜ ã£ã¦ã„ã‚‹ã®ã¯ã€ã‚ãªãŸè‡ªèº«ã ã€‚`);

  // Show initial integrity
  addBlock(`
    <div class="mirror-integrity-display">
      <div class="big-pct healthy" id="big-integrity">100%</div>
      <div class="int-label">MIRROR INTEGRITY</div>
    </div>
  `);

  setTimeout(() => startMirrorRound(0), 1200);
}

async function startMirrorRound(round) {
  if (round >= 5) {
    // Mirror phase complete
    setTimeout(startFinalAnalysis, 800);
    return;
  }

  updateProgress(((3 + round) / 8) * 100);
  updateStepHUD(3 + round + 1, TOTAL_STEPS, 'é¡ã¨ã®å¯¾è©±');
  addDivider(`å¯¾è©± ${round + 1} / 5`);

  // Generate mirror's question via API
  const mirrorLoader = showLoading('é¡ãŒèªã‚Šã‹ã‘ã¦ã„ã‚‹â€¦â€¦', 'GENERATING MIRROR DIALOGUE', [
    'å¼±ã•ã®ç´ æã‚’èª­ã¿è¾¼ã¿ä¸­â€¦',
    'é¡ã®äººæ ¼ã‚’æ§‹ç¯‰ä¸­â€¦',
    'å¯¾è©±ã‚’ç”Ÿæˆä¸­â€¦',
    'èªã‚Šã‹ã‘ã‚’èª¿æ•´ä¸­â€¦'
  ]);

  const seedContext = Object.values(state.seedAnswers).map((a, i) =>
    `å¼±ã•${i + 1}: ${a}`
  ).join('\n');

  const prevDialogues = state.mirrorDialogues.map((d, i) =>
    `[å¯¾è©±${i + 1}] é¡: ${d}\nãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ${state.playerResponses[i] || '(æœªå›ç­”)'}\næ„Ÿæƒ…ã‚¹ã‚³ã‚¢: æ¸©ã‹ã•${state.emotionScores[i]?.warmth || '?'} å…±æ„Ÿ${state.emotionScores[i]?.empathy || '?'} å³ã—ã•${state.emotionScores[i]?.severity || '?'}`
  ).join('\n\n');

  try {
    const resp = await fetch('/api/claude', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        system: `ã‚ãªãŸã¯ã€Œé¡ã€ã§ã™ã€‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¼±ã•ã‚’æ˜ ã—å‡ºã™å­˜åœ¨ã§ã™ã€‚
ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¼±ã•ã®æƒ…å ±ã‚’å…ƒã«ã€ä¸€äººç§°ã€Œã‚ãŸã—ã€ã§æ‚©ã¿ã‚’ç›¸è«‡ã—ã¦ãã ã•ã„ã€‚

ãƒ«ãƒ¼ãƒ«ï¼š
- ã‚ãªãŸã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è‡ªèº«ã®å¼±ã•ã®åŒ–èº«ã§ã™
- å…·ä½“çš„ã§ç”Ÿã€…ã—ã„æ‚©ã¿ã‚’èªã£ã¦ãã ã•ã„
- 3ã€œ5æ–‡ç¨‹åº¦ã§ã€åˆ‡å®Ÿã«èªã‚Šã‹ã‘ã¦ãã ã•ã„
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¼±ã•ã®ç´ æã‚’å¿…ãšåæ˜ ã—ã¦ãã ã•ã„
- å›ã‚’è¿½ã†ã”ã¨ã«ã€ã‚ˆã‚Šæ·±ã„å±¤ã®æ‚©ã¿ã‚’å‡ºã—ã¦ãã ã•ã„
- ã€Œã‚ãŸã—ã€ã¨ã„ã†ä¸€äººç§°ã§è©±ã—ã¦ãã ã•ã„
- ç›¸è«‡èª¿ã§ã€åŠ©ã‘ã‚’æ±‚ã‚ã‚‹ã‚ˆã†ã«è©±ã—ã¦ãã ã•ã„
- å‰å›ã¾ã§ã®å¯¾è©±ãŒã‚ã‚Œã°ã€ãã‚Œã‚’è¸ã¾ãˆã¦æ·±åŒ–ã•ã›ã¦ãã ã•ã„
- ãƒ†ã‚­ã‚¹ãƒˆã®ã¿è¿”ã—ã¦ãã ã•ã„ã€‚JSONä¸è¦ã€‚`,
        messages: [{
          role: 'user',
          content: `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¼±ã•ï¼š\n${seedContext}\n\n${prevDialogues ? 'å‰å›ã¾ã§ã®å¯¾è©±ï¼š\n' + prevDialogues + '\n\n' : ''}ã“ã‚Œã¯å¯¾è©±${round + 1}/5ã§ã™ã€‚é¡ã¨ã—ã¦æ‚©ã¿ã‚’èªã‚Šã‹ã‘ã¦ãã ã•ã„ã€‚`
        }]
      })
    });

    const data = await resp.json();
    const mirrorText = data.content.map(c => c.text || '').join('');

    mirrorLoader.complete();
    await new Promise(r => setTimeout(r, 400));
    mirrorLoader.remove();
    state.mirrorDialogues.push(mirrorText);

    addMirrorSpeech(mirrorText);
    showInput('é¡ã«å¿œã˜ã‚ã€‚ã‚ãªãŸã®è¨€è‘‰ãŒã€é¡ã®é‹å‘½ã‚’æ±ºã‚ã‚‹ã€‚', 'å¿œã˜ã‚‹');

    awaitingCallback = async (answer) => {
      state.playerResponses.push(answer);
      await analyzeResponse(round, mirrorText, answer);
    };

  } catch (err) {
    console.error(err);
    mirrorLoader.remove();
    addNarrative('é¡ã¨ã®æ¥ç¶šãŒé€”åˆ‡ã‚ŒãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ã»ã—ã„ã€‚', true);
  }
}

async function analyzeResponse(round, mirrorText, playerResponse) {
  const emotionLoader = showLoading('åå¿œã‚’è§£æä¸­â€¦â€¦', 'EMOTION ANALYSIS', [
    'è¨€èªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ†æä¸­â€¦',
    'æ„Ÿæƒ…å€¤ã‚’æ•°å€¤åŒ–ä¸­â€¦',
    'é¡ã¸ã®å½±éŸ¿ã‚’è¨ˆç®—ä¸­â€¦',
    'çµæœã‚’å‡ºåŠ›ä¸­â€¦'
  ]);

  try {
    const resp = await fetch('/api/claude', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        system: `ã‚ãªãŸã¯æ„Ÿæƒ…åˆ†æã‚¨ãƒ³ã‚¸ãƒ³ã§ã™ã€‚ã€Œé¡ã€ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è‡ªèº«ã®å¼±ã•ã®åŒ–èº«ï¼‰ãŒæ‚©ã¿ã‚’ç›¸è«‡ã—ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒãã‚Œã«å¿œã˜ã¾ã—ãŸã€‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¿œç­”ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚

é¡ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è‡ªèº«ã®å¼±ã•ã§ã™ã€‚ã¤ã¾ã‚Šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¿œç­”ã¯ã€Œè‡ªåˆ†è‡ªèº«ã®å¼±ã•ã«ã©ã†å‘ãåˆã†ã‹ã€ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚

ä»¥ä¸‹ã®JSONã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ï¼š
{
  "warmth": 1ã€œ10ã®æ•´æ•°ï¼ˆæ¸©ã‹ã•ã€‚å—å®¹çš„ãƒ»å„ªã—ã„ãƒ»å¯„ã‚Šæ·»ã† = é«˜ã„ï¼‰,
  "empathy": 1ã€œ10ã®æ•´æ•°ï¼ˆå…±æ„Ÿåº¦ã€‚ç›¸æ‰‹ã®æ°—æŒã¡ã‚’ç†è§£ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ = é«˜ã„ï¼‰,
  "severity": 1ã€œ10ã®æ•´æ•°ï¼ˆå³ã—ã•ã€‚çªãæ”¾ã™ãƒ»å¦å®šã™ã‚‹ãƒ»å†·ãŸã„ = é«˜ã„ï¼‰,
  "flame": 1ã€œ10ã®æ•´æ•°ï¼ˆå¿ƒã«ç«ã‚’ç¯ã™åŠ›ã€‚å‹‡æ°—ã‚’ä¸ãˆã‚‹ãƒ»å¸Œæœ›ã‚’è¦‹ã›ã‚‹ãƒ»è¡Œå‹•ã‚’ä¿ƒã™ = é«˜ã„ï¼‰,
  "mirror_impact": "crack"ã‹"glow"ã‹"neutral"ï¼ˆé¡ã¸ã®å½±éŸ¿ã€‚å†·ãŸã„/å¦å®šçš„ãªã‚‰crackã€æ¸©ã‹ã„/å…±æ„Ÿçš„ãªã‚‰glowã€ä¸­ç«‹ãªã‚‰neutralï¼‰,
  "crack_amount": 0ã€œ20ã®æ•´æ•°ï¼ˆãƒ’ãƒ“ã®æ·±ã•ã€‚crackã®å ´åˆã®ã¿æ„å‘³ãŒã‚ã‚‹ï¼‰,
  "glow_amount": 0ã€œ15ã®æ•´æ•°ï¼ˆå…‰ã®å¼·ã•ã€‚glowã®å ´åˆã®ã¿æ„å‘³ãŒã‚ã‚‹ï¼‰,
  "comment": "ã“ã®å¿œç­”ãŒæ˜ ã—å‡ºã™ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è‡ªåˆ†è‡ªèº«ã¸ã®æ…‹åº¦ã‚’1æ–‡ã§"
}`,
        messages: [{
          role: 'user',
          content: `é¡ã®ç™ºè¨€ï¼š${mirrorText}\n\nãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¿œç­”ï¼š${playerResponse}\n\nJSONã®ã¿è¿”ã—ã¦ãã ã•ã„ã€‚`
        }]
      })
    });

    const data = await resp.json();
    const text = data.content.map(c => c.text || '').join('');
    const clean = text.replace(/```json|```/g, '').trim();
    const result = JSON.parse(clean);

    emotionLoader.complete();
    await new Promise(r => setTimeout(r, 400));
    emotionLoader.remove();

    state.emotionScores.push(result);
    state.totalFlame += (result.flame || 0);
    state.responseCount++;

    // Update mirror integrity
    if (result.mirror_impact === 'crack') {
      state.mirrorIntegrity = Math.max(0, state.mirrorIntegrity - (result.crack_amount || 10));
    } else if (result.mirror_impact === 'glow') {
      state.mirrorIntegrity = Math.min(100, state.mirrorIntegrity + (result.glow_amount || 5));
    }

    // Show emotion meter
    showEmotionMeter(result.warmth, result.empathy, result.severity, result.flame);

    // Show impact
    if (result.mirror_impact === 'crack') {
      showImpact('cold', `é¡ã«ãƒ’ãƒ“ãŒå…¥ã£ãŸã€‚â€”â€”${result.comment}`);
    } else if (result.mirror_impact === 'glow') {
      showImpact('warm', `é¡ãŒæ·¡ãå…‰ã£ãŸã€‚â€”â€”${result.comment}`);
    } else {
      showImpact('neutral', `é¡ã¯é™ã‹ã«æºã‚ŒãŸã€‚â€”â€”${result.comment}`);
    }

    // Update HUD & integrity display
    updateIntegrityHUD();
    const bigInt = document.getElementById('big-integrity');
    if (bigInt) {
      const v = Math.max(0, Math.round(state.mirrorIntegrity));
      bigInt.textContent = v + '%';
      bigInt.className = 'big-pct ' + (v <= 30 ? 'danger' : v <= 60 ? 'warning' : 'healthy');
    }

    setTimeout(() => startMirrorRound(round + 1), 1000);

  } catch (err) {
    console.error(err);
    emotionLoader.remove();
    // Fallback: proceed anyway
    state.emotionScores.push({ warmth: 5, empathy: 5, severity: 5, flame: 3, mirror_impact: 'neutral', comment: 'è§£æä¸èƒ½' });
    state.totalFlame += 3;
    state.responseCount++;
    setTimeout(() => startMirrorRound(round + 1), 600);
  }
}

// â•â•â• FINAL ANALYSIS â•â•â•
async function startFinalAnalysis() {
  hudPhase.textContent = 'FINAL ANALYSIS';
  updateProgress(100);
  await showPhaseTransition('âˆ', 'æœ€çµ‚è§£æ', 'é¡ãŒæ˜ ã—ãŸã€ã‚ãªãŸã®å…¨å®¹');

  addDivider('æœ€çµ‚è§£æ');
  updateStepHUD(TOTAL_STEPS, TOTAL_STEPS, 'æœ€çµ‚è§£æ');
  const finalLoader = showLoading('å…¨å¯¾è©±è¨˜éŒ²ã‚’çµ±åˆè§£æä¸­â€¦â€¦', 'GENERATING FINAL REPORT', [
    'å…¨è¨¼è¨€ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆä¸­â€¦',
    'æ„Ÿæƒ…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¨ªæ–­åˆ†æä¸­â€¦',
    'é¡ã®å¥å…¨åº¦ã‚’æœ€çµ‚è¨ˆç®—ä¸­â€¦',
    'è‡ªç”»åƒã‚’æ§‹ç¯‰ä¸­â€¦',
    'ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­â€¦'
  ]);

  const seedContext = Object.values(state.seedAnswers).map((a, i) => `å¼±ã•${i + 1}: ${a}`).join('\n');
  const dialogContext = state.mirrorDialogues.map((d, i) =>
    `[å¯¾è©±${i + 1}]\né¡: ${d}\nãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ${state.playerResponses[i]}\næ„Ÿæƒ…: æ¸©ã‹ã•${state.emotionScores[i]?.warmth} å…±æ„Ÿ${state.emotionScores[i]?.empathy} å³ã—ã•${state.emotionScores[i]?.severity} ç«${state.emotionScores[i]?.flame}\nå½±éŸ¿: ${state.emotionScores[i]?.mirror_impact} ã‚³ãƒ¡ãƒ³ãƒˆ: ${state.emotionScores[i]?.comment}`
  ).join('\n\n');

  const integrity = Math.round(state.mirrorIntegrity);
  const avgFlame = state.responseCount > 0 ? Math.round(state.totalFlame / state.responseCount * 10) / 10 : 0;

  try {
    const resp = await fetch('/api/claude', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 4000,
        system: `ã‚ãªãŸã¯ã€ŒHAGAKURE MYSTERY â€”â€”é¡ã®æ³•å‰‡ã€ã®æœ€çµ‚è§£æã‚¨ãƒ³ã‚¸ãƒ³ã§ã™ã€‚

ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯è‡ªèº«ã®å¼±ã•ã‚’å‘Šç™½ã—ã€ãã®å¼±ã•ã®åŒ–èº«ï¼ˆé¡ï¼‰ã¨5å›å¯¾è©±ã—ã¾ã—ãŸã€‚
ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¿œç­”ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ã€Œè‡ªåˆ†è‡ªèº«ã«ã©ã†å‘ãåˆã£ã¦ã„ã‚‹ã‹ã€ã‚’æ˜ ã—å‡ºã—ã¦ã„ã¾ã™ã€‚

é¡ã®æœ€çµ‚å¥å…¨åº¦: ${integrity}%
å¹³å‡ç«åŠ›ï¼ˆå¿ƒã«ç¯ã™åŠ›ï¼‰: ${avgFlame}/10

ä»¥ä¸‹ã®JSONã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ï¼š

{
  "mirror_diagnosis": {
    "title": "æœ€ã‚‚æ ¸å¿ƒçš„ãªä¸€è¨€ã§ã‚¿ã‚¤ãƒˆãƒ«åŒ–",
    "self_treatment_pattern": "ã‚ãªãŸãŒè‡ªåˆ†è‡ªèº«ã«å¯¾ã—ã¦å–ã£ã¦ã„ã‚‹æ…‹åº¦ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ2ã€œ3æ–‡ï¼‰",
    "hidden_tenderness": "å†·ãŸã•ã‚„å³ã—ã•ã®è£ã«éš ã‚Œã¦ã„ã‚‹æœ¬å½“ã®æ°—æŒã¡ï¼ˆ2ã€œ3æ–‡ï¼‰",
    "crack_meaning": "é¡ã®ãƒ’ãƒ“ãŒæ„å‘³ã™ã‚‹ã“ã¨ï¼ˆ1ã€œ2æ–‡ï¼‰",
    "light_meaning": "é¡ã®å…‰ãŒæ„å‘³ã™ã‚‹ã“ã¨ï¼ˆ1ã€œ2æ–‡ï¼‰",
    "core_message": "é¡ã‹ã‚‰ã‚ãªãŸã¸ã®æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆé¡ã®ä¸€äººç§°ã€Œã‚ãŸã—ã€ã§ã€2ã€œ3æ–‡ï¼‰"
  },
  "flame_report": {
    "total_flame_score": ${state.totalFlame},
    "flame_meaning": "ç«åŠ›ã‚¹ã‚³ã‚¢ãŒæ„å‘³ã™ã‚‹ã“ã¨ï¼ˆ2ã€œ3æ–‡ï¼‰",
    "strongest_moment": "æœ€ã‚‚å¿ƒã«ç«ã‚’ç¯ã—ãŸç¬é–“ã®èª¬æ˜ï¼ˆ1ã€œ2æ–‡ï¼‰",
    "weakest_moment": "æœ€ã‚‚ç«ãŒå¼±ã‹ã£ãŸç¬é–“ã®èª¬æ˜ï¼ˆ1ã€œ2æ–‡ï¼‰"
  },
  "self_portrait": {
    "how_you_treat_weakness": "ã‚ãªãŸã¯å¼±ã•ã«ã“ã†å‘ãåˆã†äººé–“ã ï¼ˆæ–­è¨€å½¢å¼ã€1æ–‡ï¼‰",
    "what_you_really_want": "ã‚ãªãŸãŒæœ¬å½“ã«æ±‚ã‚ã¦ã„ã‚‹ã‚‚ã®ï¼ˆ1æ–‡ï¼‰",
    "the_question_remaining": "ã“ã®ä½“é¨“ãŒæ®‹ã™ã€ä¸€ã¤ã®å•ã„"
  },
  "stats": {
    "self_compassion": 1ã€œ10,
    "courage_to_face": 1ã€œ10,
    "flame_power": 1ã€œ10,
    "honesty": 1ã€œ10,
    "mirror_integrity_final": ${integrity}
  },
  "title": {
    "name": "ãã®äººå›ºæœ‰ã®ç§°å·",
    "description": "ç§°å·ã®æ„å‘³ï¼ˆ2ã€œ3è¡Œï¼‰"
  },
  "closing_hook": {
    "personal_pain": "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ ¸å¿ƒçš„ãªç—›ã¿ã‚’1æ–‡ã§çªãï¼ˆæ–­è¨€å½¢å¼ã€‚ã€Œã‚ãªãŸã¯ã€‡ã€‡ã ã¨æ°—ã¥ã„ã¦ã„ã‚‹ã€‚ã€ã®ã‚ˆã†ã«ã€æœ¬äººãŒè–„ã€…æ„Ÿã˜ã¦ã„ã‚‹ã“ã¨ã‚’è¨€èªåŒ–ã™ã‚‹ï¼‰",
    "why_cant_change": "ãªãœä»Šã®ç’°å¢ƒã§ã¯å¤‰ã‚ã‚Œãªã„ã®ã‹ã‚’ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å›ºæœ‰ã®çŠ¶æ³ã«åˆã‚ã›ã¦1ã€œ2æ–‡ã§ï¼ˆã€Œã‚ãªãŸã®ã€‡ã€‡ã¯ã€æ—¥å¸¸ã®ä¸­ã«ã„ã‚‹é™ã‚Šã€‡ã€‡ã ã€ã®ã‚ˆã†ã«å…·ä½“çš„ã«ï¼‰",
    "what_hagakure_breaks": "è‘‰éš ãŒãã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã¨ã£ã¦ä½•ã‚’å£Šã™å ´æ‰€ã«ãªã‚‹ã‹ã€1æ–‡ã§ï¼ˆã€Œã‚ãªãŸã®ã€‡ã€‡ã¨ã„ã†å‰æãŒã€é€šç”¨ã—ãªããªã‚‹ã€ã®ã‚ˆã†ã«ï¼‰"
  }
}

ãƒˆãƒ¼ãƒ³ï¼šã‚·ãƒªã‚¢ã‚¹ã€‚è¤’ã‚ãªã„ã€‚ç­”ãˆã‚’æ¸¡ã•ãªã„ã€‚æ·±ãã€é‹­ãã€‚å…¨ã¦æ—¥æœ¬èªã€‚JSONã®ã¿ã€‚
closing_hookã¯ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å…¨è¨¼è¨€ãƒ»å¼±ã•ãƒ»å¯¾è©±ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å…ƒã«ã€ãã®äººã ã‘ã«åˆºã•ã‚‹è¨€è‘‰ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã€‚ãƒ†ãƒ³ãƒ—ãƒ¬çš„ãªè¨€è‘‰ã¯ç¦æ­¢ã€‚`,
        messages: [{
          role: 'user',
          content: `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¼±ã•ï¼š\n${seedContext}\n\nå…¨å¯¾è©±è¨˜éŒ²ï¼š\n${dialogContext}\n\næœ€çµ‚è§£æã‚’JSONå½¢å¼ã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚`
        }]
      })
    });

    const data = await resp.json();
    const text = data.content.map(c => c.text || '').join('');
    const clean = text.replace(/```json|```/g, '').trim();
    const result = JSON.parse(clean);

    finalLoader.complete();
    await new Promise(r => setTimeout(r, 500));
    finalLoader.remove();
    renderFinalOutput(result);

  } catch (err) {
    console.error(err);
    finalLoader.remove();
    addNarrative('æœ€çµ‚è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã€‚\nå†èª­ã¿è¾¼ã¿ã—ã¦å†è©¦è¡Œã—ã¦ã»ã—ã„ã€‚', true);
  }
}

function renderFinalOutput(r) {
  hudPhase.textContent = 'CASE RESOLVED';

  const d = r.mirror_diagnosis;
  const f = r.flame_report;
  const s = r.self_portrait;
  const st = r.stats;

  // 1. Mirror Diagnosis
  setTimeout(() => {
    addBlock(`
      <div class="output-section">
        <div class="output-header"><span class="output-icon">01</span>é¡ã®è¨ºæ–­æ›¸ã€€â€”â€”${d.title}</div>
        <div class="output-body">
<h3>ã‚ãªãŸã®è‡ªå·±å¯¾å¿œãƒ‘ã‚¿ãƒ¼ãƒ³</h3>
${d.self_treatment_pattern}

<h3>å³ã—ã•ã®è£ã«éš ã‚Œã¦ã„ã‚‹ã‚‚ã®</h3>
${d.hidden_tenderness}

<h3>ãƒ’ãƒ“ã®æ„å‘³</h3>
${d.crack_meaning}

<h3>å…‰ã®æ„å‘³</h3>
${d.light_meaning}

<h3>é¡ã‹ã‚‰ã®æœ€å¾Œã®è¨€è‘‰</h3>
<em>${d.core_message}</em>
        </div>
      </div>
    `);
  }, 300);

  // 2. Flame Report
  setTimeout(() => {
    addBlock(`
      <div class="output-section">
        <div class="output-header"><span class="output-icon">02</span>ç«åŠ›ãƒ¬ãƒãƒ¼ãƒˆã€€â€”â€”å¿ƒã«ç¯ã£ãŸç‚ã®è¨˜éŒ²</div>
        <div class="output-body">
<h3>ç·ç«åŠ›ã‚¹ã‚³ã‚¢ï¼š${f.total_flame_score} / 50</h3>
${f.flame_meaning}

<h3>æœ€ã‚‚ç«ãŒå¼·ã‹ã£ãŸç¬é–“</h3>
${f.strongest_moment}

<h3>æœ€ã‚‚ç«ãŒå¼±ã‹ã£ãŸç¬é–“</h3>
${f.weakest_moment}
        </div>
      </div>
    `);
  }, 1100);

  // 3. Self Portrait
  setTimeout(() => {
    addBlock(`
      <div class="output-section">
        <div class="output-header"><span class="output-icon">03</span>è‡ªç”»åƒã€€â€”â€”é¡ãŒæ˜ ã—ãŸã‚ãªãŸ</div>
        <div class="output-body">
<h3>å¼±ã•ã¸ã®å‘ãåˆã„æ–¹</h3>
${s.how_you_treat_weakness}

<h3>ã‚ãªãŸãŒæœ¬å½“ã«æ±‚ã‚ã¦ã„ã‚‹ã‚‚ã®</h3>
${s.what_you_really_want}

<h3>ã“ã®ä½“é¨“ãŒæ®‹ã™å•ã„</h3>
${s.the_question_remaining}
        </div>
      </div>
    `);
  }, 1900);

  // 4. Stats
  setTimeout(() => {
    const stats = [
      { label: 'è‡ªå·±æ…ˆæ‚²åŠ›', val: st.self_compassion, cls: 'gold' },
      { label: 'ç›´è¦–ã™ã‚‹å‹‡æ°—', val: st.courage_to_face, cls: 'gold' },
      { label: 'ç«ã‚’ç¯ã™åŠ›', val: st.flame_power, cls: 'cyan' },
      { label: 'æ­£ç›´ã•', val: st.honesty, cls: 'gold' }
    ];

    let statHtml = `<div style="font-family:var(--font-mono);font-size:0.68rem;color:var(--text-dim);margin-bottom:20px;letter-spacing:0.1em;">é¡ã®æœ€çµ‚å¥å…¨åº¦ï¼š${st.mirror_integrity_final}%</div>`;
    stats.forEach(s => {
      statHtml += `
        <div class="stat-row">
          <span class="stat-label">${s.label}</span>
          <div class="stat-bar-track"><div class="stat-bar-fill ${s.cls}" data-value="${s.val * 10}" style="width:0%;position:relative;"></div></div>
          <span class="stat-value" style="color:var(--accent);">${s.val}/10</span>
        </div>`;
    });
    statHtml += `<div style="font-family:var(--font-mono);font-size:0.6rem;color:var(--text-dim);margin-top:24px;line-height:1.9;">â€»ã“ã‚Œã¯ã‚ãªãŸã®èƒ½åŠ›ã§ã¯ãªã„ã€‚<br>ã€€ä»Šæ—¥ã€é¡ã«æ˜ ã£ãŸæ…‹åº¦ã®è¨˜éŒ²ã ã€‚</div>`;

    const block = addBlock(`
      <div class="output-section">
        <div class="output-header"><span class="output-icon">04</span>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
        <div class="output-body" style="white-space:normal;">${statHtml}</div>
      </div>
    `);
    setTimeout(() => {
      block.querySelectorAll('.stat-bar-fill').forEach(b => { b.style.width = b.dataset.value + '%'; });
    }, 300);
  }, 2700);

  // 5. Title
  setTimeout(() => {
    addBlock(`
      <div class="title-award">
        <div class="award-label">ç§° å· ç™º è¡Œ</div>
        <div class="award-name">ã€Œ${r.title.name}ã€</div>
        <div class="award-desc">${r.title.description}</div>
      </div>
    `);
  }, 3500);

  // 6. Sales Closing (è‘‰éš ã‚»ãƒ¼ãƒ«ã‚¹ãƒšãƒ¼ã‚¸)
  setTimeout(() => {
    const hook = r.closing_hook || {};
    const personalPain = hook.personal_pain || '';
    const whyCantChange = hook.why_cant_change || '';
    const whatBreaks = hook.what_hagakure_breaks || '';

    addBlock(`
      <div class="sales-section">
        <div class="sales-header">
          <div class="sales-logo">è‘‰éš </div>
        </div>

        ${personalPain ? `
        <div class="sales-hook">
          <div class="hook-personal">${personalPain}</div>
        </div>` : ''}

        <div class="sales-body">
          <div class="sales-text">å¤‰ã‚ã‚ŠãŸã„ã¨æ€ã£ã¦ã„ã‚‹ã€‚
ãã‚Œã§ã‚‚ã€å¤‰ã‚ã‚Œãªã„ã€‚

ç†ç”±ã¯æ–¹æ³•ã§ã¯ãªã„ã€‚<span class="emp">å ´æ‰€</span>ã ã€‚

${whyCantChange ? whyCantChange + '\n\n' : ''}æ—¥å¸¸ã®ä¸­ã§å‰æã¯å£Šã‚Œãªã„ã€‚
æ—¥å¸¸ãã®ã‚‚ã®ãŒã€å‰æã§ã§ãã¦ã„ã‚‹ã‹ã‚‰ã ã€‚

${whatBreaks ? whatBreaks + '\n\n' : ''}è‘‰éš ã¯å²¡å±±ã«ã‚ã‚‹ã€‚
1æ³Š2æ—¥ã€‚å°‘äººæ•°ã€‚å®Œå…¨ã‚¯ãƒ­ãƒ¼ã‚ºãƒ‰ã€‚

ç­”ãˆã¯æ¸¡ã•ãªã„ã€‚
ãŸã â€”â€”å‰æãŒé€šç”¨ã—ãªã„ç’°å¢ƒã«ã€ã‚ãªãŸã‚’ç½®ãã€‚

1æ³Š2æ—¥ã¯çŸ­ã„ã¨æ„Ÿã˜ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚
ã—ã‹ã—è€ƒãˆã¦ã¿ã‚ã€‚

<span class="emp">ã‚ãªãŸã®äººç”ŸãŒå¤‰ã‚ã£ãŸç¬é–“ã‚’ã€‚</span>
å¤±æ‹ã—ãŸæœã€‚èª°ã‹ã®ä¸€è¨€ã€‚ã‚ã‚‹å¤œã®æ±ºæ–­ã€‚

äººç”ŸãŒå¤‰ã‚ã‚‹æ™‚ã¯ã€ä¸€æ°—ã«å¤‰ã‚ã‚‹ã€‚
æ™‚é–“ã¯é–¢ä¿‚ãªã„ã€‚<span class="emp">å ´æ‰€ã¨ã€è¦šæ‚Ÿ</span>ã ã‘ãŒé–¢ä¿‚ã™ã‚‹ã€‚</div>
        </div>

        <div class="sales-question">ã ã‹ã‚‰å•ã†ã€‚<br><br>ã‚ãªãŸã«ã€å¤‰ã‚ã‚‹å‹‡æ°—ãŒã‚ã‚‹ã‹ã€‚<br>ã„ã¤ã‹ã§ã¯ãªãâ€”â€”<span style="color:var(--accent);">ã™ãã«</span>ã€å¤‰ã‚ã‚‹å‹‡æ°—ãŒã€‚</div>

        <div class="sales-condition">æ¥ã‚‹ã¹ãäººé–“ã¯ä¸€ã¤ã ã‘æ¡ä»¶ãŒã‚ã‚‹ã€‚<br>è‹¦ã—ã¿ã®åŸå› ãŒã€è‡ªåˆ†ã®å†…å´ã«ã‚ã‚‹ã¨â€”â€”<br>è–„ã€…ã€æ°—ã¥ã„ã¦ã„ã‚‹äººé–“ã€‚</div>

        <div class="sales-final">æ—¥ç¨‹ã‚‚ä¾¡æ ¼ã‚‚ã“ã“ã«ã¯æ›¸ã‹ãªã„ã€‚<br><br>ã“ã®æ–‡ç« ã‚’èª­ã‚“ã§ã€ä½•ã‹ãŒå¼•ã£ã‹ã‹ã£ãŸãªã‚‰ã€‚<br><span class="final-accent">ãã®å¼•ã£ã‹ã‹ã‚ŠãŒã€ç­”ãˆã ã€‚</span></div>

        <div class="line-cta-wrap">
          <a href="https://lin.ee/cfH44jK" target="_blank" rel="noopener" class="line-cta">
            <svg viewBox="0 0 24 24"><path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.627-.63h2.386c.349 0 .63.285.63.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.627-.63.349 0 .631.285.631.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/></svg>
            è‘‰éš ã«ã¤ã„ã¦èã
          </a>
          <div class="line-cta-sub">â€» æ—¥ç¨‹ãƒ»è©³ç´°ã¯LINEã§ã®ã¿ãŠä¼ãˆã—ã¦ã„ã¾ã™</div>
        </div>
      </div>

      <div class="case-closed-final">CASE CLOSED.</div>
    `);
  }, 4300);
}

// â•â•â• INIT â•â•â•
startGame();
</script>
</body>
</html>
